name: C++ CI Testing

on:
  pull_request:
  push:
    branches: [ master ]
    tags: [ '*' ]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true # cancel in-progress workflows on the same PR branch

defaults:
  run:
    shell: bash

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    container:
      image: codecr.jlab.org/hallb/clas12/container-forge/base_root:latest

    steps:

      - name: checkout repository
        uses: actions/checkout@v5

      - name: set clas12root env vars
        run: |
          CLAS12ROOT=$GITHUB_WORKSPACE
          PATH=$CLAS12ROOT/bin${PATH:+:${PATH}}
          LD_LIBRARY_PATH=$CLAS12ROOT/lib${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}
          ROOT_INCLUDE_PATH=$CLAS12ROOT/Clas12Root:$CLAS12ROOT/Clas12Banks${ROOT_INCLUDE_PATH:+:${ROOT_INCLUDE_PATH}}
          echo CLAS12ROOT=$CLAS12ROOT | tee -a $GITHUB_ENV
          echo PATH=$PATH | tee -a $GITHUB_ENV
          echo LD_LIBRARY_PATH=$LD_LIBRARY_PATH | tee -a $GITHUB_ENV
          echo ROOT_INCLUDE_PATH=$ROOT_INCLUDE_PATH | tee -a $GITHUB_ENV

      - name: print versions
        run: |
          cmake --version
          root --version

      - name: build clas12root
        run: ./installC12Root

      - name: run example on data file
        run: ./bin/clas12root -q ./tests/read_file.C
